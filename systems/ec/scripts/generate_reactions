#!/usr/bin/env python3

import os, sys

sys.path.append(os.path.join(os.path.dirname(__file__), os.path.pardir, 'python'))
from tcg_slb.reactions import SLBReactions

reference = "generate_reactions"

os.chdir(os.path.abspath(os.path.dirname(__file__)))

def generate_reactions(outdir):

    phases = ['Clinopyroxene', 'Orthopyroxene', 'Quartz', 'Feldspar', 'Garnet','Kyanite','Olivine','Nepheline','Spinel']

    # what about the following SLB phases:
        # spinel
        # coesite
        # stishovite
        # wuestite--periclase SS (magnesiowuestite)? (FeO-MgO)

    # it would also be easy(?) to add pure-endmember phases from the HGP database

    an = ['Feldspar', 'Anorthite']
    ab = ['Feldspar','Albite']

    fs = ['Orthopyroxene', 'Ferrosilite']
    oEn = ['Orthopyroxene', 'Enstatite']
    mgts = ['Orthopyroxene','MgTschermaks']
    oDi = ['Orthopyroxene', 'OrthoDiopside']

    hed = ['Clinopyroxene', 'Hedenbergite']
    di = ['Clinopyroxene', 'Diopside']
    jd = ['Clinopyroxene','Jadeite']
    cats = ['Clinopyroxene','CaTschermaks']
    cEn = ['Clinopyroxene','Clinoenstatite']

    alm = ['Garnet', 'Almandine']
    pyp = ['Garnet', 'Pyrope']
    gs = ['Garnet', 'Grossular']
    mgmaj = ['Garnet','MgMajorite']
    namaj = ['Garnet','NaMajorite']

    qz = ['Quartz', 'Quartz']

    ky = ['Kyanite', 'Kyanite']


    ###

    fo = ['Olivine','Forsterite']
    fa = ['Olivine','Fayalite']
    mgsp = ['Spinel','MgSpinel']
    hc = ['Spinel','Hercynite']
    neph = ['Nepheline','Nepheline']
    
    #mag = ['Ferropericlase','Magnetite']

    reactions = [
        # plag +- opx <=> grt
        ([an,oEn],[di,mgts,qz]),
        ([an],[cats,qz]),

        # plag + opx <=> grt + cpx + qz
        # ([oEn, fs, an],[pyp, alm, di, hed, qz]),
         ([oEn, an],[pyp, di, qz]),
         ([fs, an],[alm, hed, qz]),

        # ([oEn, fs, an],[pyp, alm, gs, qz]),
        ([oEn, an],[pyp, gs, qz]),
        ([fs, an],[alm, gs, qz]),

        # Al-opx/cpx + Al-cpx/opx <=> grt
        ([oEn, mgts], [pyp]),
        ([cats, oEn], [gs, pyp]),

        # albite <=> jadeite + quartz
        ([ab], [jd, qz]),

        ### Mafic

        # ol + qtz <=> opx
        ([fo, qz], [oEn]),
        ([fa, qz], [fs]),

        # ol + opx <=> cpx
        ([fo, oEn], [cEn]),
        ([fo, oEn, an], [hed,cats]),
        # iron?


        # ol + ru <=> ilm + opx
        # (no Ti)

        # ([fo,an], [di, cats, oEn, mgts]),
        ([fo,an], [di, cats, mgts]),
        ([fo,an], [di, cats, oEn]),
        ([fo,an], [di, oEn, mgts]),
        ([fo,an], [cats, oEn, mgts]),

        ([fo,an], [di,oEn, mgsp]),

        #([pyp,gs,fo],[mgsp,oEn,di]),
        ([gs,fo],[mgsp,oEn,di]),
        ([pyp,fo],[mgsp,oEn,di]),

        ([fo,an], [gs,pyp]),
        ([fa,an], [gs,alm]),
        ([mgsp,an,oEn], [gs,pyp]),
        ([hc,an,fs], [gs,alm]),
        ([ab,oEn,mgsp], [jd,pyp]),
        ([ab,fs,hc], [jd,alm]),
        ([an], [gs,ky,qz]),

        # ([ab,mag,di],[]),
        # ([jd,mag,oEn,qz],[]),

        # Nepheline - NaAlSiO4

        #([ab, neph], [jd]),
        #([neph, fo],[jd,pyp]),
        #([neph, fa],[jd,alm]),

        #([neph, di],[jd,gs]),
        #([neph, hed],[jd,pyp]),

    ]

    #generate_reaction(outdir, 'eclogitization_olivine', phases, reactions)

    reactions = [

        # plag <=> Cpx + qtz
        ([an],[cats,qz]),
        ([ab], [jd, qz]),

        # an <=> gs + ky + qz
        ([an], [gs,ky,qz]),

        # Plag + Opx <=> Grt + qz
        ([an, oEn],[pyp, gs, qz]),
        ([an, fs],[alm, gs, qz]),

        # plag + opx <=> cpx + opx + qz
        ([an,oEn],[di, mgts, qz]),

        # plag + opx <=> grt + cpx + qz
        ([an, oEn],[pyp, di, qz]),
        ([an, fs],[alm, hed, qz]),
        ([an, mgts],[pyp,gs,qz]),

        # Al-opx/cpx + Al-cpx/opx <=> Grt
        ([oEn, mgts], [pyp]),
        ([oEn, cats], [gs, pyp]),
        
        # Plag + opx + Sp <=> Grt
        ([an,mgsp,oEn], [gs,pyp]),
        ([an,fs,hc], [gs,alm]),
        ([ab,oEn,mgsp], [jd,pyp]),
        ([ab,fs,hc], [jd,alm]),

        # Cpx + plag = grt + qz
        ([di,an],[gs,pyp,qz]),
        ([hed,an],[gs,alm,qz]),
        ([cats,an],[gs,qz]),
    ]

    generate_reaction(outdir, 'eclogitization_crustal', phases, reactions)

def generate_reaction(outdir, name, phases, reactions):

    dbfile = os.path.join(os.path.pardir, 'database', 'tcg_slb_database.tar.gz')
    dbpath = "file://{}".format(dbfile)

    try:
        os.mkdir(outdir)
    except FileExistsError:
        pass

    name = name+"_slb_rx"
    phases = [ph+"_slb_ph" for ph in phases]
    print(phases)
    rxn = SLBReactions(name, len(reactions), phases, dbpath, reference)
    for reaction in reactions:
        reactants = [[[ph+"_slb_ph", em+"_slb_em"] for ph, em in reaction[i]] for i in range(2)]
        rxn.add_reaction(*reactants)
    rxn.tofile(outdir)

if __name__ == "__main__":
    import argparse
    import os

    parser = argparse.ArgumentParser( \
                           description="""Generate rxmls for a given thermodynamic database.""")
    parser.add_argument('-o', '--outdir', action='store', metavar='outdir', 
                        default=os.path.join(os.path.pardir, 'database', 'reactions'), type=str, required=False,
                        help='Output directory for rxml files (defaults to ../database/reactions relative to script).')

    args = parser.parse_args()
    print(args.outdir)
    generate_reactions(args.outdir)

